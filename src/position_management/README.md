# Position Management Module

The Position Management module is responsible for handling position creation, tracking, sizing, and risk management within the trading system. It provides a comprehensive framework for managing both individual positions and the entire portfolio.

## Core Components

### Position Manager

The `PositionManager` coordinates position sizing, allocation, and risk management:

```python
# Create a position manager
position_manager = PositionManager(
    portfolio=portfolio,
    position_sizer=position_sizer,
    allocation_strategy=allocation_strategy,
    risk_manager=risk_manager,
    max_positions=10
)
```

Key responsibilities:
- Processes trading signals to generate position actions
- Calculates appropriate position sizes
- Applies risk management rules
- Executes position entry and exit
- Tracks portfolio risk exposure

### Portfolio

The `Portfolio` class manages multiple positions and tracks overall account performance:

```python
# Create a portfolio
portfolio = Portfolio(
    initial_capital=100000,
    name="Main Portfolio",
    currency="USD",
    allow_fractional_shares=True,
    margin_enabled=False,
    leverage=1.0
)
```

Key features:
- Tracks open and closed positions
- Maintains cash, equity, and margin
- Records performance metrics
- Handles position entry and exit
- Provides performance analysis

### Position

The `Position` class represents a single trading position:

```python
# Create a position
position = portfolio.open_position(
    symbol="AAPL",
    direction=1,  # Long
    quantity=100,
    entry_price=150.0,
    entry_time=datetime.now(),
    stop_loss=145.0,
    take_profit=160.0
)
```

Key capabilities:
- Tracks entry and exit details
- Maintains current position metrics
- Handles stop loss and take profit levels
- Supports trailing stops
- Calculates P&L and performance metrics

## Integration with Event System

The Position Management module integrates with the event system through:

### Signal Event Handler

Processes signal events to generate position actions:

```python
def on_signal(self, signal_event):
    """Process a signal event and generate appropriate position actions."""
    # Extract signals from the event
    signal = signal_event.data
    
    # Process signals into position actions
    actions = self._process_signals(signal)
    
    return actions
```

### Fill Event Handler

Processes fill events to update the portfolio:

```python
def on_fill(self, fill_event):
    """Handle fill events and update the portfolio accordingly."""
    # Extract fill data from the event
    fill_data = fill_event.data
    
    symbol = fill_data.get('symbol')
    direction = fill_data.get('direction')
    quantity = fill_data.get('quantity')
    fill_price = fill_data.get('fill_price')
    timestamp = fill_data.get('timestamp')
    
    # Create a new position in the portfolio
    position = self.portfolio.open_position(
        symbol=symbol,
        direction=direction,
        quantity=quantity,
        entry_price=fill_price,
        entry_time=timestamp
    )
    
    return {
        "action": "entry",
        "position_id": position.position_id
    }
```

## Position Actions

The Position Manager generates and executes several types of position actions:

### Entry Actions

```python
entry_action = {
    'action': 'entry',
    'symbol': 'AAPL',
    'direction': 1,  # Buy/Long
    'size': 100,
    'price': 150.0,
    'stop_loss': 145.0,
    'take_profit': 160.0
}
```

### Exit Actions

```python
exit_action = {
    'action': 'exit',
    'position_id': 'position_123',
    'symbol': 'AAPL',
    'price': 155.0,
    'reason': 'Trailing stop triggered',
    'exit_type': ExitType.STOP_LOSS
}
```

### Modify Actions

```python
modify_action = {
    'action': 'modify',
    'position_id': 'position_123',
    'stop_loss': 148.0,
    'take_profit': 165.0,
    'trailing_stop': 2.0
}
```

## Managing Positions

### Opening Positions

The position ID is automatically generated by the Portfolio class:

```python
position = portfolio.open_position(
    symbol="AAPL",
    direction=1,  # Long
    quantity=100,
    entry_price=150.0,
    entry_time=datetime.now(),
    stop_loss=145.0,
    take_profit=160.0
)
```

### Closing Positions

```python
summary = portfolio.close_position(
    position_id="position_123",
    exit_price=155.0,
    exit_time=datetime.now(),
    exit_type=ExitType.STRATEGY
)
```

### Updating Position Values

The Portfolio tracks position values based on the most recent prices. To update position values with current market prices, you must update each position's `last_price` attribute and recalculate unrealized P&L:

```python
# Update a position with current price
for position in portfolio.positions.values():
    position.last_price = current_prices[position.symbol]
    
    # Recalculate P&L
    if position.direction > 0:  # Long
        pnl = (position.last_price - position.entry_price) * position.quantity
    else:  # Short
        pnl = (position.entry_price - position.last_price) * position.quantity
        
    position.unrealized_pnl = pnl
    position.unrealized_pnl_pct = pnl / (position.entry_price * position.quantity) * 100
```

## Performance Metrics

```python
# Get portfolio performance metrics
metrics = portfolio.get_performance_metrics()

# Important metrics
initial_capital = metrics['initial_capital']
current_equity = metrics['current_equity']
total_return = metrics['roi_percent']
max_drawdown = metrics['max_drawdown_percent']
win_rate = metrics['win_rate_percent']
```

## Risk Exposure

```python
# Get portfolio risk exposure
risk_metrics = position_manager.get_portfolio_risk_exposure()

# Important risk metrics
capital_at_risk = risk_metrics['capital_at_risk_pct']
long_exposure = risk_metrics['exposure_by_direction']['long']
short_exposure = risk_metrics['exposure_by_direction']['short']
diversification = risk_metrics['diversification']
```

## Best Practices

1. **Use the Portfolio Methods** for creating and closing positions
2. **Implement proper risk management** by always setting stop losses
3. **Choose appropriate position sizing** based on your strategy's characteristics
4. **Monitor portfolio-level metrics** not just individual positions
5. **Update position prices regularly** with current market prices
6. **Record transaction costs** to get accurate performance metrics
7. **Implement trailing stops** for trend-following strategies
8. **Use appropriate allocation strategies** for your portfolio's objectives
9. **Handle partial fills** correctly to maintain accurate position tracking
10. **Integrate with the event system** for consistent system-wide communication

## Troubleshooting

- **Position Not Opening**: Check if you have sufficient capital or if risk limits are being exceeded
- **Stop Loss Not Triggering**: Ensure you're updating position prices with each new bar of data
- **Portfolio Equity Issues**: Verify that positions are being properly marked to market
- **Signal Processing Errors**: Confirm that signals contain all required information (symbol, direction, price)
- **Missing Trades in History**: Check that positions are being properly closed and recorded
- **Unrealized P&L Not Updating**: Make sure you're updating each position's `last_price` and recalculating P&L
